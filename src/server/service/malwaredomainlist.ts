import * as rp from "request-promise"
const cheerio = require('cheerio')

import { pgClient } from "../services"

const rUrl = /^(?:https?:\/\/)?(?:www\.)?([^\/]+)/

class MalwaredomainlistService {
  getMalwareList() {
    return rp({
      uri: "https://www.malwaredomainlist.com/mdl.php?search=&colsearch=All&quantity=All",
      method: "GET",
    }).then((html) => {
      const $ = cheerio.load(html)

      const matches = $(".ContentBox table tr td:nth-child(2)")
      const malwareList = []

      for (var i = 0; i < matches.length; i++) {
        malwareList.push(rUrl.exec(matches.eq(i).text())[1])
      }

      return malwareList
    })
  }

  async run() {
    const malwareList = await this.getMalwareList()

    malwareList.forEach(async (domainName) => {
      await pgClient.query(
        "INSERT INTO domains(name, reason, reason_url, reason_details) VALUES($1, $2, $3, $4) ON CONFLICT DO NOTHING",
        [
          domainName,
          2,
          "https://www.malwaredomainlist.com/mdl.php?search=&colsearch=All&quantity=All",
          "SCANNED_MALWARE",
        ],
      )
    })
  }
}

export default MalwaredomainlistService
